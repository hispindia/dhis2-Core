<!DOCTYPE html>
<html lang="en">
<head>
    <!-- jQuery -->
    <script src="js/jquery-2.1.3.js"></script>
    <script src="js/angular.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="//dhis2-cdn.org/v221/ext/ext-all.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
    <title>User Registration</title>

    <style>
        #footer{
            position: absolute;
            right: 0;
            bottom: 0;
            left: 0;
            padding: 1rem;
            background-color:#2978B3;
            text-align: center;}
        header{
            background-color:#2978B3;
        }
        #formHeader{
            background-color:#2978B3;
        }

        body{
            background-color:#E5E3E3;
        }
    </style>

</head>


<body>
</body>
<script type="text/javascript">
    var orgid;
    $(document)
            .ready(function() {
                var header = {

                    "Authorization": "Basic " + btoa( "admin" + ':' + "district" )

                };

                $.ajax({
                    async : false,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json",
                    header : header,
                    url: '../../api/organisationUnitGroups/mH15ENlpG4v.json?fields=organisationUnits[id,name,code]',
                    success: function(response){
                        var organisationUnits = response.organisationUnits;

                        organisationUnits.sort(function(a, b) {
                            var nameA=a.name.toLowerCase(), nameB=b.name.toLowerCase()
                            if (nameA < nameB) //sort string ascending
                                return -1
                            if (nameA > nameB)
                                return 1
                            return 0 //default return value (no sorting)
                        });
                        $.each(organisationUnits, function (index, item) {
                            $('#drop1').append(
                                    $('<option></option>').val(item.id).html(item.name).text(item.name)
                            );
//
                        });

                    },
                    error: function(response){

                    }
                });

                $("#drop1").change(function () {
                    orgid = $(this).find("option:selected").val();

                    jQuery('#sel').html('');


                });

            });


    function submitdata(){
        var orgname=document.getElementById("hospital").value;
        var password=document.getElementById("password").value;
        var username=document.getElementById("username").value;
        var email=document.getElementById("email").value;
        var header = {

            "Authorization": "Basic " + btoa( "admin" + ':' + "district" )

        };

        var orgunit = {

            name:orgname,
            code : orgname,
            parent:{
                id : orgid
            },
            openingDate:"2016-01-01",
            shortName: orgname,
            phoneNumber : "98566"
        }

        $.ajax({
            async : false,
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            header : header,
            url: '../../api/organisationUnits/',
            data: JSON.stringify(orgunit),
            success: function(response){
                var orgid=response.response.lastImported;
                assignprogram(orgid);
                createUser(orgid);

            },
            error: function(response){

            }
        });





        function  assignprogram(orgid)
        {
            $.ajax({
                async : false,
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                header : header,
                url: '../../api/programs/tzR46QRZ6FJ/organisationUnits/'+orgid,
                success: function(response){

                },
                error: function(response){

                }
            });

            $.ajax({
                async : false,
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                header : header,
                url: '../../api/programs/oKibT84LSdV/organisationUnits/'+orgid,
                success: function(response){

                },
                error: function(response){

                }
            });

        }

        function  createUser(orgid)
        {
            var user = {
                firstName:username,
                surname : username,
                email:email,
                userCredentials: {
                    "username": username,
                    "password": password,
                    "userRoles": [ {
                        "id": "ccSI4dsXeFI"
                    } ]
                },

                organisationUnits:[{

                    id:orgid
                }]
            }

            $.ajax({
                async : false,
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                header : header,
                url: '../../api/users/',
                data: JSON.stringify(user),
                success: function(response){
                alert("User successfully registered please login to continue!")
                window.close();
                },
                error: function(response){


                }
            });

        }



    }




</script>


<header class="w3-card" >
    <h1 style="color:#fff; text-align:center;  font-weight: bold;">Punjab Health Facility Portal</h1>
</header>

</br>
<div class="w3-card-4" style="margin-left:400px; background-color:white; margin-right:400px;">

    <div id="formHeader" class="w3-container">
        <h2 style="color:white; font-weight: bold; text-align:center">Registration Form</h2>
    </div>
    <form style="margin-left:10px; margin-right:10px;">
        <p>
            <select class="w3-select w3-border" name="option" id="drop1">
                <option value="" disabled selected>Please Select Your District</option>
            </select>
        <p>
            <label>User Name</label>
            <input class="w3-input" type="text" id="username"></p>
        <p>
            <label>Email: </label>
            <input class="w3-input" type="email" id="email"></p>
        <p>
            <label>Password</label>
            <input class="w3-input" type="password" id="password"></p>
        <p>
            <label>Hospital Name</label>
            <input class="w3-input" type="text" id="hospital"></p>
        <p style="padding:20px; text-align:center"><button class="w3-btn" id="submit" onclick="submitdata()" style="background-color:#2978B3">Register</button></p>
    </form>
</div>
</html>